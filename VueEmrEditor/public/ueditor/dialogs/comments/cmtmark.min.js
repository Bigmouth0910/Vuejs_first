"use strict";UE.plugins.postil=function(){function optimize(t){var e=t.startContainer,o=t.endContainer;(e=domUtils.findParentByTagName(e,tag,!0))&&t.setStartBefore(e),(o=domUtils.findParentByTagName(o,tag,!0))&&t.setEndAfter(o)}function getPreviousNode(t){var e=t.startContainer,o=t.endContainer;console.log(e),console.log(o)}var me=this,domUtils=UE.dom.domUtils,tag="mark";me.commands.postil={execCommand:function(t,e){var o=me.selection.getRange(),n=o.collapsed?me.queryCommandValue("postil"):me.selection.getStart();if(n&&n.tagName.toLowerCase()==tag.toLowerCase()&&"postil"==n.getAttribute("plugins"))n.setAttribute("content",e.content),n.setAttribute("author",e.author),n.setAttribute("date",e.date);else{console.log(tag);o.cloneContents(),o.applyInlineStyle(tag,{style:"background-color: rgb(255, 255, 0) !important;font-style: normal;",plugins:"postil",content:e.content,author:e.author,date:e.date})}o.collapse().select(!0)},queryCommandValue:function(){var t,e=this.selection.getRange();if(t=e.startContainer,(t=1==t.nodeType?t:t.parentNode)&&(t=domUtils.findParentByTagName(t,tag,!0))&&!domUtils.isInNodeEndBoundary(e,t))return t}},me.commands.unpostil={execCommand:function(){var t,e=this.selection.getRange();e.collapsed&&!domUtils.findParentByTagName(e.startContainer,tag,!0)||(getPreviousNode(e),t=e.createBookmark(),optimize(e),console.log(e),e.removeInlineStyle(tag).moveToBookmark(t).select())}};var popup=new baidu.editor.ui.Popup({editor:this,content:"",className:"edui-bubble",_edittext:function(){me.ui._dialogs.cmdDialog.open(),this.hide()},_delete:function(){window.confirm("确认删除该批注吗？")&&(console.log(this.anchorEl),me.execCommand("unpostil")),this.hide()}});popup.render(),me.addListener("click",function(t,evt){evt=evt||window.event;var el=evt.target||evt.srcElement;domUtils.findParent(el,function(node){if(eval("/"+tag+"/ig").test(node.tagName)&&"postil"==node.getAttribute("plugins")){var content=node.getAttribute("content"),author=node.getAttribute("author"),date=node.getAttribute("date"),pathname=parent.location.pathname,pagename=pathname.slice(pathname.lastIndexOf("/")+1),html=popup.formatHtml('<div style="width:200px;">'+date+"&nbsp;"+author+": <p>"+content+'</p><div style="text-align:right;"><span onclick=$$._edittext() class="edui-clickable">编辑</span>&nbsp;<span onclick=$$._delete() class="edui-clickable">删除</span></div></div>');html?(popup.getDom("content").innerHTML=html,popup.anchorEl=node,popup.showAnchor(popup.anchorEl)):popup.hide()}},!0)})},UE.registerUI("showpostil",function(t,e){var o=this;return new UE.ui.Button({name:"显示批注",title:"显示批注",cssRules:"background: url("+t.options.UEDITOR_HOME_URL+"dialogs/comments/showPostil.png) no-repeat 3px 2px / 74% !important",onclick:function(){var t=o.document.getElementsByTagName("mark");UE.utils.each(t,function(t,e){"hidepostil"==t.getAttribute("plugins")&&(t.setAttribute("plugins","postil"),UE.dom.domUtils.setStyle(t,"background-color","rgb(255, 255, 0)"))})}})}),UE.registerUI("hidepostil",function(t,e){var o=this;return new UE.ui.Button({name:"隐藏批注",title:"隐藏批注",cssRules:"background: url("+t.options.UEDITOR_HOME_URL+"dialogs/comments/hidePostil.png) no-repeat 3px 2px / 76% !important",onclick:function(){var t=o.document.getElementsByTagName("mark");UE.utils.each(t,function(t,e){"postil"==t.getAttribute("plugins")&&(t.setAttribute("plugins","hidepostil"),UE.dom.domUtils.removeStyle(t,"background-color"))})}})});